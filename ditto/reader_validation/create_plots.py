import matplotlib.pyplot as plt
import pandas as pd
from itertools import combinations
import numpy as np
import math

## This function creates a dictonary with R0,X0,R1,X1 values for each reader for the plots to use
def plots_dict(input_dict):
    """Create a dictionary of combinations of readers to create bar graphs"""
    comp_values = {}
    for name in input_dict.keys():
        comp_values[name] = {}
        for each_reader in input_dict[name].keys():
            # each_reader = each_reader.split("_")[0]
            comp_values[name][each_reader] = {}
            comp_values[name][each_reader]["R0"] = []
            comp_values[name][each_reader]["X0"] = []
            comp_values[name][each_reader]["R1"] = []
            comp_values[name][each_reader]["X1"] = []
            for (k, v) in input_dict[name][each_reader].items():
                comp_values[name][each_reader]["R0"].append(v[0])
                comp_values[name][each_reader]["X0"].append(v[1])
                comp_values[name][each_reader]["R1"].append(v[2])
                comp_values[name][each_reader]["X1"].append(v[3])
    return comp_values


# This function creates the histograms for R0,X0,R1,X1 values for each reader
def plots(input_dict):
    comp_values = plots_dict(input_dict)
    for comp_key in comp_values.keys():
        fig, axes = plt.subplots(4, 4, figsize=(10, 7), tight_layout=True)
        for row, each_plot in zip(axes, comp_values[comp_key].keys()):
            for col, each_node, seq_imp in zip(
                row, comp_values[comp_key][each_plot].keys(), ["R0", "X0", "R1", "X1"]
            ):
                if col.is_first_col():
                    col.set_ylabel(
                        each_plot.split("_")[0], rotation="horizontal", ha="right"
                    )
                if col.is_first_row():
                    col.set_title(seq_imp)
                v = comp_values[comp_key][each_plot][each_node]
                col.hist(v)
        plt.show()


# This function creates a dictionary which computes the differences between the R0,X0,R1,X1 values for all the combinations of readers taking two at a time.
def differences_dict(input_dict):
    """Create a dictionary of combinations of readers to create bar graphs"""
    # Getting the combinations of the formats
    for each_case in input_dict.keys():
        comb = combinations(input_dict[each_case].keys(), 2)
        x = list(comb)
        comp_values = {}
        comp_values[each_case] = {}
        for each in x:
            name = each[0].split("_")[0] + " vs " + each[1].split("_")[0]
            comp_values[each_case][name] = {}
            comp_values[each_case][name]["R0"] = []
            comp_values[each_case][name]["X0"] = []
            comp_values[each_case][name]["R1"] = []
            comp_values[each_case][name]["X1"] = []
            for (k, v), (k1, v1) in zip(
                input_dict[each_case][each[0]].items(),
                input_dict[each_case][each[1]].items(),
            ):
                comp_values[each_case][name]["R0"].append(abs(v[0] - v1[0]))
                comp_values[each_case][name]["X0"].append(abs(v[1] - v1[1]))
                comp_values[each_case][name]["R1"].append(abs(v[2] - v1[2]))
                comp_values[each_case][name]["X1"].append(abs(v[3] - v1[3]))
    return comp_values


# This function plots the differences of R0,X0,R1,X1 values between any 2 readers
def plots_differences(input_dict):
    comp_values = differences_dict(input_dict)
    width = 0.2
    for each_case in comp_values.keys():
        fig, axes = plt.subplots(6, 4, figsize=(10, 7), sharex=True, sharey=True)
        for row, comp_key in zip(axes, comp_values[each_case].keys()):
            for col, each_plot in zip(row, comp_values[each_case][comp_key].keys()):
                if col.is_first_col():
                    col.set_ylabel(comp_key, rotation="horizontal", ha="right")
                if col.is_first_row():
                    col.set_title(each_plot)
                v = comp_values[each_case][comp_key][each_plot]
                col.bar(len(v), v, width, color="tab:blue")
                col.set_ylim(0, 15)
                col.set_xticks(
                    np.add(y_pos, (width / 2))
                )  # set the position of the x ticks
                # col.set_xticklabels(input_dict[each_case].keys()) # Need consistent names of nodes in reader in order to name each bar

    # plt.suptitle('Differences of sequence impedances', size=14)
    fig.tight_layout()
    plt.show()


# Tests for running the plots independently
# if __name__ == "__main__":
# plots_differences({'ieee_4node': {'cyme_output': {'1': [1.796043190045738, 5.388117303585387, 0.10784685850195197, 0.5904760366014294], '2': [2.0202605985010313, 6.518985500570162, 0.22820004614399358, 0.8158267453203445], '3': [0.2536631703405771, 0.8984713888134145, 0.06581202655980385, 0.24831713333607722], '4': [0.5340964354229437, 2.3119539172019614, 0.23396047634518685, 0.46239954705589636]}, 'gridlabd_output': {'sourcebus': [1.7960358301233543, 5.388107490370064, 1.6037668205527515, 6.415067282211007], 'node2': [11.615625751028661, 11.520529778987775, 9.073598525409436, 5.8609512435066655], 'node3': [1.2918305507375225, 1.2769209930818217, 1.0089298663668416, 0.6470699623879508], 'load4': [0.8640026377752124, 0.41845221416471984, 0.8640056993976751, 0.4184497947877163], 'node1': [11.95788550650638, 12.207304856874984, 9.189536257036401, 6.043847565567804]}, 'opendss_output': {'sourcebus': [0.0002463564270509644, 0.0007390394604267333, 0.00018858267905109123, 0.0007542723977164494], 'n2': [0.29564583680274237, 0.7167450994489304, 0.11638654713225582, 0.2358768460293939], 'n3': [0.06870713919610347, 0.23863115122119738, 0.048858783362332986, 0.18910852255356034], 'n4': [0.5051857600366919, 0.7781653125896516, 0.21133259350889166, 0.4141945608522559]}, 'synergi_output': {'node_61746791326': [0.000999999415454687, 0.0009999923015324673, 0.0009999996415073831, 0.0009999921771822826], 'node_61746791327': [1.4052433405517772, 0.8534261345199505, 1.100207413576314, 0.09925701086833777], 'node_61746839533': [0.5767771891663984, 1.2140898058567755, 0.5400898631419725, 1.138540681909626], 'node_61746842036': [2.2802968553458975, 1.9930774142792114, 1.8176517572334512, 1.1452767401123385]}}})

# plots({'ieee_4node': {'cyme_output': {'1': [1.796043190045738, 5.388117303585387, 0.10784685850195197, 0.5904760366014294], '2': [2.0202605985010313, 6.518985500570162, 0.22820004614399358, 0.8158267453203445], '3': [0.2536631703405771, 0.8984713888134145, 0.06581202655980385, 0.24831713333607722], '4': [0.5340964354229437, 2.3119539172019614, 0.23396047634518685, 0.46239954705589636]}, 'gridlabd_output': {'sourcebus': [1.7960358301233543, 5.388107490370064, 1.6037668205527515, 6.415067282211007], 'node2': [11.615625751028661, 11.520529778987775, 9.073598525409436, 5.8609512435066655], 'node3': [1.2918305507375225, 1.2769209930818217, 1.0089298663668416, 0.6470699623879508], 'load4': [0.8640026377752124, 0.41845221416471984, 0.8640056993976751, 0.4184497947877163], 'node1': [11.95788550650638, 12.207304856874984, 9.189536257036401, 6.043847565567804]}, 'opendss_output': {'sourcebus': [0.0002463564270509644, 0.0007390394604267333, 0.00018858267905109123, 0.0007542723977164494], 'n2': [0.29564583680274237, 0.7167450994489304, 0.11638654713225582, 0.2358768460293939], 'n3': [0.06870713919610347, 0.23863115122119738, 0.048858783362332986, 0.18910852255356034], 'n4': [0.5051857600366919, 0.7781653125896516, 0.21133259350889166, 0.4141945608522559]}, 'synergi_output': {'node_61746791326': [0.000999999415454687, 0.0009999923015324673, 0.0009999996415073831, 0.0009999921771822826], 'node_61746791327': [1.4052433405517772, 0.8534261345199505, 1.100207413576314, 0.09925701086833777], 'node_61746839533': [0.5767771891663984, 1.2140898058567755, 0.5400898631419725, 1.138540681909626], 'node_61746842036': [2.2802968553458975, 1.9930774142792114, 1.8176517572334512, 1.1452767401123385]}}})

# plots({'ieee_4node': {'cyme_output': {'1': [1.796043190045738, 5.388117303585387, 0.10784685850195197, 0.5904760366014294], '2': [2.0202605985010313, 6.518985500570162, 0.22820004614399358, 0.8158267453203445], '3': [0.2536631703405771, 0.8984713888134145, 0.06581202655980385, 0.24831713333607722], '4': [0.5340964354229437, 2.3119539172019614, 0.23396047634518685, 0.46239954705589636]}, 'gridlabd_output': {'sourcebus': [1.7960358301233543, 5.388107490370064, 1.6037668205527515, 6.415067282211007], 'node2': [11.615625751028661, 11.520529778987775, 9.073598525409436, 5.8609512435066655], 'node3': [1.2918305507375225, 1.2769209930818217, 1.0089298663668416, 0.6470699623879508], 'load4': [0.8640026377752124, 0.41845221416471984, 0.8640056993976751, 0.4184497947877163], 'node1': [11.95788550650638, 12.207304856874984, 9.189536257036401, 6.043847565567804]}, 'opendss_output': {'sourcebus': [0.0002463564270509644, 0.0007390394604267333, 0.00018858267905109123, 0.0007542723977164494], 'n2': [0.29564583680274237, 0.7167450994489304, 0.11638654713225582, 0.2358768460293939], 'n3': [0.06870713919610347, 0.23863115122119738, 0.048858783362332986, 0.18910852255356034], 'n4': [0.5051857600366919, 0.7781653125896516, 0.21133259350889166, 0.4141945608522559]}, 'synergi_output': {'node_61746791326': [0.000999999415454687, 0.0009999923015324673, 0.0009999996415073831, 0.0009999921771822826], 'node_61746791327': [1.4052433405517772, 0.8534261345199505, 1.100207413576314, 0.09925701086833777], 'node_61746839533': [0.5767771891663984, 1.2140898058567755, 0.5400898631419725, 1.138540681909626], 'node_61746842036': [2.2802968553458975, 1.9930774142792114, 1.8176517572334512, 1.1452767401123385]}}, 'ieee_13node': {'cyme_output': {'650': [1.6442002249862027, 2.525071217368887, 0.00175590064769382, 0.013818660541591976], '633': [2.191962671993786, 2.7645145724914206, 0.13502678340376117, 0.30258402028428943], '634': [0.03373885959967424, 0.0437948202860033, 0.006851233217346727, 0.01281928879314106], '7': [1.6444948113338582, 2.5248296649991535, 0.0027565424317121945, 0.014811194353743895], 'rg60': [1.6444956621823732, 2.524829864977333, 0.002756707027920302, 0.014813876873885912], '632': [2.1103087225772716, 2.527515777000864, 0.0791161472443358, 0.2320482533916044], '652': [1.2506186991395154, 1.2878722947329384, 1.2506186991395154, 1.2878722947329384], '611': [1.1239472985549395, 1.3770646713358636, 1.1239472985549395, 1.3770646713358636], '692': [2.631742710227492, 2.70681263013228, 0.16404792757812026, 0.44179116013620445], '645': [2.2388323604857887, 2.784026210466048, 0.1850730276433944, 0.31739303544051045], '646':[2.317657028721549, 2.949917446377885, 0.24850513527121498, 0.3676808102436452], '671': [2.630682474394549, 2.706364834017407, 0.16301316760562778, 0.44085146992520197], '675': [2.7067614833052813, 2.7173749384388346, 0.23870615585157873, 0.47708961405564254], '684': [2.6970360888981926, 2.8036701407791496, 0.23157910972791085, 0.5317115549334911], '680': [2.7200580191836536, 3.2662254613120227, 0.19824054093535326, 0.5540558678888127]}, 'gridlabd_output': {}, 'opendss_output': {'sourcebus': [0.17960357997560872, 0.5388107499674782, 0.16044213136336458, 0.6414216083753025], '650': [3.46173977571697e-05, 0.00027688611330264445, 0.00024463297015852746, 0.0011161493255213788], 'rg60': [0.0003803596442662037, 0.0006225803505498496, 0.0005903829452526287, 0.0014616392165030185], '633': [0.38047984831844595, 0.8729366035169337, 0.13271664569004354, 0.28972479926771977], '634': [0.010133922766079825, 0.020570453379602505, 0.006830751758597249, 0.012931935773494248], '671': [0.6108771018713602, 1.3265863413420522, 0.16093756369535386, 0.42423496513300524], '645': [0.4373080269407039, 0.8584390204064538, 0.18280284255143675, 0.32024566175842095], '646': [0.536560726260114, 0.9883607573047537, 0.24564544687076215, 0.36912074589189336], '692': [0.6119751654440972, 1.3274110796789444, 0.16196524206540175, 0.4251679482288616], '675': [0.7447836834016821, 1.3496142794655475, 0.20882248763406844, 0.46165856154276824], '611': [0.47109807838681994, 0.8597942885112269, 0.47109807838681994, 0.8597942885112269], '652': [0.5900525671135924, 0.8394468662430931, 0.5900525671135924, 0.8394468662430931], '670': [0.3852338293138269, 0.8975161336344963, 0.1039477429886314, 0.2879817616207214], '632': [0.2799093266146708, 0.6803831271514527, 0.07670340676752073, 0.21819919790776035], '680': [0.7346431542735055, 1.6877642140995293, 0.19615949605780691, 0.5372620670065573], '684': [0.7244901189090343, 1.397819420078607, 0.22833210323410577, 0.4698019455814719]}, 'synergi_output': {}}})
